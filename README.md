# Active-Response-Vulnerability-Detection-and-Command-Monitoring-with-Wazuh

## Objective
This lab aims to configure and utilize Wazuh's capabilities to automate threat responses, enable endpoint vulnerability scanning by checking installed software against an updated vulnerability database, and configure command monitoring to track the output of commands run on endpoints. This can be used to gather various statistics or information on the endpoint being monitored. The objective is to gain a comprehensive understanding of how Wazuh can be leveraged for robust security monitoring and incident response across all endpoints within a network.

## Lab Setup
The lab consists of two Virtual Machines (VMs). The Wazuh server is installed on an Ubuntu VM, and the agent is installed on a Windows VM. VMware is used as the virtualization platform.

## Skills Learned
- Automate responses to security threats
- Software Vulnerability Detection
- Using command monitoring to get and read information from endpoint

## Tools Used
- Wazuh
- VMware

## Active Response
Active response is the method by which Wazuh automates responses to threats on monitored endpoints. It is a crucial part of the SIEM, enabling security teams to address high-priority security events in a timely manner and execute mitigation actions. Without automated responses, security teams struggle to collect relevant incident information in real-time, making it difficult to assess the full scope of an attack. Automated responses are triggered by scripts based on specific alerts, such as rule IDs, rule levels, or rule group triggers.
Active response scripts for endpoints should be placed at `C:\Program Files (x86)\ossec-agent\active-response\bin`. You'll notice some scripts already present, which can be utilized.

## Use case: Restarting the Wazuh agent
In earlier configurations, the Wazuh agent had to be manually stopped and started after each change. To streamline this, we’ll use a script to restart the agent automatically. The trigger for this action? Let's reason it like this: When a change to a file occurs, the file’s hash changes. Therefore, the trigger is based on file hash change of the ossec.conf file.

### Configure the Wazuh Server
Navigate to `/var/ossec/etc/rules/local_rules.xml` to open the local rules file. Add the rule below, which detects modifications to the `ossec.conf` file using the file modification rule. The rule ID will be used as a trigger for the Wazuh-restart script.
```xml
  <group name="restart,">
  <rule id="100003" level="5">
    <if_sid>550</if_sid>
    <match>ossec.conf</match>
    <description>Changes made to the agent configuration file - $(file)</description>
  </rule>
</group>
```    
![Local rules for wazuh restart script](https://github.com/user-attachments/assets/147e0060-3a9f-4da2-9ca4-df8b62f25cac)    

Edit the Wazuh server configuration by running command:
```xml
  sudo nano /var/ossec/ossec.conf
```
Ensure the following lines are present. You can use `Ctrl+W` in the nano editor to search for `restart-wazuh`. These lines tell the server to use the script named `restart-wazuh` on the endpoint:
```xml
<command>
  <name>restart-wazuh</name>
  <executable>restart-wazuh</executable>
</command>
```    
![ossec configuration for restart-wazuh](https://github.com/user-attachments/assets/e911868b-248a-4e91-8077-d642b9633c8a)    

Append the following lines to the end of the file. This makes the server demand that the script be run on the endpoint when our custom rule is triggered: 
```xml
  <ossec_config>
  <active-response>
    <command>restart-wazuh</command>
    <location>local</location>
    <rules_id>100009</rules_id>
  </active-response>
</ossec_config>
```    
![ossec configuration for restart-wazuh n2](https://github.com/user-attachments/assets/7209e62a-8dab-4003-8b0f-a56fb85c6dfd)    

### Restart the Wazuh Server
Use the command below to restart the server.
```xml
sudo systemctl restart wazuh-manager
```

### Configure the Wazuh Agent
Make the agent monitor the ossec.conf file so that when it’s modified, it triggers the file modification alert, which in turn triggers the custom rule. Add this line to the FIM section of the configuration file:
```xml
  <directories realtime="yes">C:/Program Files (x86)/ossec-agent/ossec.conf</directories>
```    
![ossec configuration for restart-wazuh client](https://github.com/user-attachments/assets/48a55cce-73a8-4cd1-ac9f-708feb6c84d2)    

### Test the Configuration
Add another directory to monitor, such as the Documents folder, by including this line in the configuration file:
```xml
  <directories>C:/Users/<YOUR USERNAME>/Documents</directories>
```    
![ossec configuration for restart-wazuh client n2](https://github.com/user-attachments/assets/6c826fbb-578d-47f5-9662-71a035d21e6d)    

### Result
The Wazuh agent will now restart automatically.

## Wazuh Vulnerability Detection
Wazuh's vulnerability detection works by having the agent create an inventory of installed applications on the endpoint. This inventory is sent to the server, which matches it against vulnerability content documents (JSON files aggregating data from multiple sources). If an installed package's version matches a vulnerability document, an alert is generated. Vulnerability detection alerts are triggered when a new vulnerability is found or an old one is fixed.

### Configure the Wazuh Server
Navigate to `/var/ossec/etc/ossec.conf` and ensure the following lines of code are present. If not append them below the `</sca>` tag.
```xml
  <vulnerability-detection>
   <enabled>yes</enabled>
   <index-status>yes</index-status>
   <feed-update-interval>60m</feed-update-interval>
</vulnerability-detection>

<indexer>
   <enabled>yes</enabled>
   <hosts>
      <host>https://<IP OF WAZUH INDEXER>:9200</host>
   </hosts>
   <ssl>
      <certificate_authorities>
         <ca>/etc/filebeat/certs/root-ca.pem</ca>
      </certificate_authorities>
      <certificate>/etc/filebeat/certs/filebeat.pem</certificate>
      <key>/etc/filebeat/certs/filebeat-key.pem</key>
   </ssl>
</indexer>
```
Ensure to replace <IP OF WAZUH INDEXER> with actual IP address of Wazuh indexer during wazuh installation setup. For this lab, the indexer is on the localhost thus 127.0.0.1 be used if following this lab exactly.

### Restart Wazuh Server
Use the command below to restart the server.
```xml
sudo systemctl restart wazuh-manager
```

### Result
Vulnerability data is available at, from Wazuh homescreen `Vulnerability Detection>Inventory` or` Vulnerability Detection>Events` for events related to vulnerable software on endpoint.    
![Vulnerability Detection](https://github.com/user-attachments/assets/9350c32e-8302-4f05-924c-1f0fdbb3e34b)    

## Command Monitoring
Wazuh command monitoring capability enables wazuh to monitor the output of specific commands and treat the output as log content. Command monitoring can be used to monitor a variety of command outputs, such as disk space utilization, load average, and list running processes to ensure all important processes are running.

## Use case: Monitoring SSH usage on an endpoint
Most users on a Windows endpoint do not need SSH for remote access, so detecting the presence of the SSH service can indicate an anomaly. Wazuh can be configured to detect SSH or any dubious service/program running.

## Configure the Wazuh Agent
The tasklist command lists processes on a Windows endpoint. We can configure the agent to run this command at regular intervals. A rule will trigger if the command output contains ssh.exe, indicating that the SSH process is running.
First, enable the agent to run commands on the endpoint by editing C:\Program Files (x86)\ossec-agent\local_internal_options.conf. Add this line:
```xml
  logcollector.remote_commands=1
```    
![log collector module rights to run commands client](https://github.com/user-attachments/assets/4ef6a759-b25a-4b1c-adbf-960be2a1f4e6)    

### Configure the Wazuh Server
Append the following lines to /var/ossec/etc/shared/default/agent.conf:
```xml
  <agent_config os="Windows">
  <localfile>
    <log_format>command</log_format>
    <command>tasklist</command>
    <alias>tasklist</alias>
    <interval>1m</interval>
  </localfile>
</agent_config>
```    
![tasklist command monitoring](https://github.com/user-attachments/assets/e8159c6a-25a4-4f85-89b2-3f869767b41a)    

Now, create a rule to detect the ssh.exe process by appending the following to /var/ossec/etc/rules/local_rules.xml:
```xml
  <group name="process_monitor">
  <rule id="100004" level="6">
    <if_sid>530</if_sid>
    <match>^ossec: output: 'tasklist':</match>
    <regex type="pcre2">(?i)sshd.exe</regex>
    <description>ssh.exe is running</description>
  </rule>
</group>
```    
![Rule to detect sshd](https://github.com/user-attachments/assets/fe4cebea-1f9e-4877-a8fb-2df1b615a113)    

### Restart Wazuh Server
Use the command below to restart the server.
```xml
sudo systemctl restart wazuh-manager
```
### Result
sshd is detected on endpoint which have it enabled. The windows 10 virtual machine for this lab does have it enabled.    
![sshd detected](https://github.com/user-attachments/assets/1305d783-673b-47e6-9e3e-a36b8e6a17a1)    

## Use case: Detecting USB usage on an endpoint
Malware spread via external drives is common. Wazuh's command monitoring can track USB device usage using the reg Query command to check registry values for connected USB devices.

### Configure the Wazuh Agent
As before, edit `C:\Program Files (x86)\ossec-agent\local_internal_options.conf` to enable command execution:
```xml
  logcollector.remote_commands=1
```
Or skip this step if the line is already present

### Restart Wazuh Agent
Open power shell with administrator priviledges and use command below to restart the agent. Or if active response section was followed the agent will restart itself.
```xml
  Restart-Service -Name Wazuh
```

### Configure the Wazuh Server
Append the following lines to /var/ossec/etc/shared/default/agent.conf:
```xml
  <agent_config os="Windows">
  <localfile>
    <log_format>command</log_format>
    <command>reg QUERY HKLM\SYSTEM\CurrentControlSet\Enum\USBSTOR</command>
    <alias>check_usb_connectivity</alias>
  </localfile>
</agent_config>
```    
![reg Query command monitoring](https://github.com/user-attachments/assets/1645a504-af19-47b5-88ec-6160d8063506)    

Now, add a rule to match the command output by appending the following to /var/ossec/etc/rules/local_rules.xml:
```xml
  <group name="detect_usb_storage">
  <rule id="100005" level="7">
    <if_sid>530</if_sid>
    <match>^ossec: output: 'check_usb_connectivity':</match>
    <description>New USB device connected</description>
  </rule>
</group>
```    
![Rule to detect usb connected](https://github.com/user-attachments/assets/1c97ff1e-beaa-476b-8be5-f37b8cb3f24d)    

### Restart the Wazuh Manager
Use the command below to restart the server.
```xml
sudo systemctl restart wazuh-manager
```
### Test Configuration
Plugin a USB. Make windows 10 virtual machines access the USB by navigating to `VM>Removable Devices>Flash Drive`

### Result
The USB device is detected.    
![USB device connected](https://github.com/user-attachments/assets/a9343f46-2c8c-49b8-ac28-aea1bf298a75)
